<html>	
<title> کودکان بازمانده از تحصیل</title>
	<meta charset="UTF-8">
    <script src="js/d3.v3.min.js" src1='http://d3js.org/d3.v3.min.js' charset="utf-8" type='text/javascript'></script>
    <script src="js/topojson.v1.min.js" src1='http://d3js.org/topojson.v1.min.js' type='text/javascript'></script>
    <script src="js/datamaps.all.min.js" src1='http://datamaps.github.io/scripts/datamaps.all.min.js' type='text/javascript'></script>
    <script src="js/handlebars.min.js" src1='http://cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.0.0/handlebars.min.js' type='text/javascript'></script>
	<script src="js/queue.v1.min.js" src1="http://d3js.org/queue.v1.min.js"></script>
	<script src="js/jquery-1.12.3.min.js"></script>
	<head>
		<link rel="stylesheet" type="text/css" href="css/outofschool.css">
	</head>
	<body>
		<script>			
			function subsetChanged (redrawMap) {
				isOstan = getRadioVal("locType");
				filterData();
				if (redrawMap)
				{
					drawMap(topoData);
					curLocID = isOstan == 0 ? "2301" : "23";
				}
				yearChange(curYear);
				drawBarCharts(curLocID);
			}
			
			function repValueChanged() {
				//console.log(valueSelector.value);
			}
			
			function getRadioVal(radioName) {
				var val;
				var radios = document.getElementsByName(radioName);

				for (var i = 0, length = radios.length; i < length; i++) {
					if (radios[i].checked) {
						// do whatever you want with the checked radio
						val = radios[i].value;
						// only one radio can be logically checked, don't check the rest
						break;
					}
				}
				return val;
			}
		
			// Return an array of the selected opion values
			// select is an HTML select element
			function getSelectValues (select) {
			  var result = [];
			  var options = select && select.options;
			  var opt;

			  for (var i=0, iLen=options.length; i<iLen; i++) {
				opt = options[i];

				if (opt.selected) {
				  result.push(opt.value || opt.text);
				}
			  }
			  return result;
			}
			
			function getSelectValues_(checkListID)
			{
				var result = [];
				items = d3.selectAll(checkListID +" li input");
				items.each(function(d) { 
					if (this.checked)
						result.push(this.value || this.text);
				});
				
				return result;
			}

		</script>
		<header>
			<form action="javascript:subsetChanged(false)">
<table border=0 style="direction:rtl" width="100%">
	<tr>
		<td width="10%">
				<!--<div class="subsetGroup">-->
				<!--
					<select class="subset" id="sexSubset" multiple value="پسر">
						<option value="پسر" selected="true">پسر</option>
						<option value="دختر" selected="true">دختر</option>
					</select>
				-->
				<ul id="sexCheckList">
					<li>
						جنسیت
					</li>
					<li>
						<label for="chkBoy">
							<input type="checkbox" name="chkBoy" id="chkBoy" value="پسر" checked>
							پسر
							</input>
						</label>
					</li>
					<li>
						<label for="chkGirl">
							<input type="checkbox" name="chkGirl" id="chkGirl" value="دختر" checked>
							دختر
							</input>
						</label>
					</li>
				</ul>
		</td>
		<td width="15%">
					<!--
					<select class="subset" id="resSubset" multiple>
						<option value="روستا" selected="true">روستایی</option>
						<option value="شهر" selected="true">شهری</option>
						<option value="غیرساکن" selected="true">غیر ساکن</option>
					</select>
					-->
				<ul class="many" id="settlementCheckList">
					<li>
						سکونت
					</li>
					<br>
					<li>
						<label for="chkRoosta">
							<input type="checkbox" name="chkRoosta" id="chkRoosta" value="روستا" checked>
							روستایی
							</input>
						</label>
					</li>
					<li>
						<label for="chkShahr">
							<input type="checkbox" name="chkShahr" id="chkShahr" value="شهر" checked>
							شهری
							</input>
						</label>
					</li>
					<li>
						<label for="chkQeir">
							<input type="checkbox" name="chkQeir" id="chkQeir" value="غیرساکن" checked>
							غیرساکن
							</input>
						</label>
					</li>
				</ul>
		</td>
		<td width="60%">
<!--
					<select class="subset" id="ageSubset" multiple>
						<option value="6" selected="true">6 ساله</option>
						<option value="7" selected="true">7 ساله</option>
						<option value="8" selected="true">8 ساله</option>
						<option value="9" selected="true">9 ساله</option>
						<option value="10" selected="true">10 ساله</option>
						<option value="11" selected="true">11 ساله</option>
						<option value="12" selected="true">12 ساله</option>
						<option value="13" selected="true">13 ساله</option>
						<option value="14" selected="true">14 ساله</option>
						<option value="15" selected="true">15 ساله</option>
						<option value="16" selected="true">16 ساله</option>
						<option value="17" selected="true">17 ساله</option>
						<option value="18" selected="true">18 ساله</option>
						<option value="19" selected="true">19 ساله</option>
					</select>
-->
				<ul class="many" id="ageCheckList">
					<li>
						سن
					</li>
					<br>
					<li>
						<label for="chkAge6">
							<input type="checkbox" name="chkAge6" id="chkAge6" value="6">
							6 ساله
							</input>
						</label>
					</li>
					<li>
						<label for="chkAge7">
							<input type="checkbox" name="chkAge7" id="chkAge7" value="7" checked>
							7 ساله
							</input>
						</label>
					</li>
					<li>
						<label for="chkAge8">
							<input type="checkbox" name="chkAge8" id="chkAge8" value="8" checked>
							8 ساله
							</input>
						</label>
					</li>
					<li>
						<label for="chkAge9">
							<input type="checkbox" name="chkAge9" id="chkAge9" value="9" checked>
							9 ساله
							</input>
						</label>
					</li>
					<li>
						<label for="chkAge10">
							<input type="checkbox" name="chkAge10" id="chkAge10" value="10" checked>
							10 ساله
							</input>
						</label>
					</li>
					<li>
						<label for="chkAge11">
							<input type="checkbox" name="chkAge11" id="chkAge11" value="11" checked>
							11 ساله
							</input>
						</label>
					</li>
					<li>
						<label for="chkAge12">
							<input type="checkbox" name="chkAge12" id="chkAge12" value="12" checked>
							12 ساله
							</input>
						</label>
					</li>
					<li>
						<label for="chkAge13">
							<input type="checkbox" name="chkAge13" id="chkAge13" value="13" checked>
							13 ساله
							</input>
						</label>
					</li>
					<li>
						<label for="chkAge14">
							<input type="checkbox" name="chkAge14" id="chkAge14" value="14" checked>
							14 ساله
							</input>
						</label>
					</li>
					<li>
						<label for="chkAge15">
							<input type="checkbox" name="chkAge15" id="chkAge15" value="15" checked>
							15 ساله
							</input>
						</label>
					</li>
					<li>
						<label for="chkAge16">
							<input type="checkbox" name="chkAge16" id="chkAge16" value="16" checked>
							16 ساله
							</input>
						</label>
					</li>
					<li>
						<label for="chkAge17">
							<input type="checkbox" name="chkAge17" id="chkAge17" value="17">
							17 ساله
							</input>
						</label>
					</li>
					<li>
						<label for="chkAge18">
							<input type="checkbox" name="chkAge18" id="chkAge18" value="18">
							18 ساله
							</input>
						</label>
					</li>
					<li>
						<label for="chkAge19">
							<input type="checkbox" name="chkAge19" id="chkAge19" value="19">
							19 ساله
							</input>
						</label>
					</li>
				</ul>

		</td>
		<td>
					<input class="button" id="subsetReset" type="reset" value="پیش فرض" onclick="(function (e, obj) { 
						console.log(this); console.log(getSelectValues(resSubset)); } )(event, this)"></input>
					<input class="button" id="subsetAll" type="button" value="همه"></input>
					<input class="button" id="subsetBtn" type="submit" value="اعمال"></input>
				<!--</div>-->
		</td>
		<td width="60%" style="direction: ltr; display:none">
				<div class="valueGroup" dir="rtl">
					<!--
					<select id="valueSelector" dir="rtl" value="percent.population.not.ed" onchange="repValueChanged()">
						<option value="population.ed">جمعیت در حال تحصیل</option>
						<option value="population.not.ed">جمعیت خارج از تحصیل</option>
						<option value="percent.population.ed">درصد در حال تحصیل</option>
						<option value="percent.population.not.ed">درصد خارج از تحصیل</option>
					</select>
					-->
					<!--<input onchange="subsetChanged(false)" type="radio" value="population.ed" name="valueSelector" checked="true">جمعیت در حال تحصیل<br></input>-->
					<inputx onchange="subsetChanged(false)" type="radio" value="population.not.ed" name="valueSelector" checked="true" >جمعیت خارج از تحصیل<br></input>
					<!--<input onchange="subsetChanged(false)" type="radio" value="percent.population.ed" name="valueSelector">درصد در حال تحصیل<br></input>-->
					<inputx onchange="subsetChanged(false)" type="radio" value="percent.population.not.ed" name="valueSelector">درصد خارج از تحصیل<br></input>
				<!--</div>-->
		</td>
				<!--<div class="valueGroup" dir="rtl">
					<input type="radio" value="1" name="locType" selected="true">استان</input>
					<input type="radio" value="0" name="locType">شهرستان</input>
				</div>-->
				</ul>
	</tr>
</table>
			</form>
		</header>
		<hr>
<table border="0" width="100%">
	<tr height="230px">
	<td rowspan="3" width="800px">
		<div id="main">
			<div class="timeSlider">
				<input id="yearSlider" type="range" min="1390" max="1395" step="5" value="1390" oninput="yearChange(value)" disabled>1390</input>

			</div>
			<div class="projectTitle">
				<p>
					کودکان بازمانده از تحصیل <br>1390
				</p>
			</div>
			<div class="locationGroup">
				<input type="radio" value="0" name="locType" onchange="subsetChanged(true)">استان</input>
				<input type="radio" value="1" name="locType" checked="true" onchange="subsetChanged(true)">شهرستان</input>
			</div>
				<div class="valueGroup" dir="rtl">
					<!--
					<select id="valueSelector" dir="rtl" value="percent.population.not.ed" onchange="repValueChanged()">
						<option value="population.ed">جمعیت در حال تحصیل</option>
						<option value="population.not.ed">جمعیت خارج از تحصیل</option>
						<option value="percent.population.ed">درصد در حال تحصیل</option>
						<option value="percent.population.not.ed">درصد خارج از تحصیل</option>
					</select>
					-->
					<!--<input onchange="subsetChanged(false)" type="radio" value="population.ed" name="valueSelector" checked="true">جمعیت در حال تحصیل<br></input>-->
					<input onchange="subsetChanged(false)" type="radio" value="population.not.ed" name="valueSelector">جمعیت</input>
					<!--<input onchange="subsetChanged(false)" type="radio" value="percent.population.ed" name="valueSelector">درصد در حال تحصیل<br></input>-->
					<input onchange="subsetChanged(false)" type="radio" value="percent.population.not.ed" name="valueSelector" checked="true">درصد</input>
				<!--</div>-->
			</div>
	</td>
	<td colspan="2" height="230px">
		<div id="locCompare"><svg id="ostansvg" /></div>
	</td>
	</tr>
	<tr height="200px">
		<td width="200">
			<div id="barChart1"></div>
		</td>
		<td>
			<div class="titledChart" id="barChart2"></div>
		</td>
	</tr>
	<tr height="200px">
		<td colspan="2">
			<div id="barChart3"></div>
		</td>
	</tr>
<!-- 		<div id="aside">
			<div id="ostan"><svg id="ostansvg" /></div>
			<div id="barChart1"></div>
			<div id="barChart2"></div>
		</div>
 -->	
	</body>
	<script>	
		//var csvUrl = "csv/Population_timeSeries_Provinces.csv"; //"https://dl.dropboxusercontent.com/s/4ue1lprzqwsiz0y/Population_timeSeries_Provinces.csv";
		//var topoUrl = "topo/piran-.json"; // "https://dl.dropboxusercontent.com/s/ytz7j0czwfxc50c/piran-.json"; 
		//var csvUrl2 = "csv/Population.csv"; //"https://dl.dropboxusercontent.com/s/0qyo4poife93rjz/Population.csv";
		//var csvProvUrl = "csv/provinces.csv";
		//var oosCsvUrl = "csv/out_of_school_children_1390.csv";
		var ostanCsvUrl = "csv/out_of_school_children_1390_1395_provinces-5.csv";
		var shahrestanCsvUrl = "csv/out_of_school_children_1390_1395.csv"
		var ostanTopoUrl = "topo/piran-amarcoded-zeropadID-.json"; //"topo/iran-os-amarcoded-.json";
		var shahrestanTopoUrl = "topo/iran-sh-90-simplified.json";
		
		var locIdFieldInCsv = "addressCode";
		var timeFieldInCsv = "year";
		var locNameFieldInCsv = "Code";
		
		var attributeArray =[ ];
		var _csvData = [];
		var _provData = [];
		var _oosData = [];
		
		// current topology
		var topoData = [];
		
		var curOstanStyleSaved = "";
		
		// current csv
		var	csvData = [];
		
		// map data
		var mapData = [];
		
		// WHOLE data (topo + csv) for (ostan + shahrestan)
		var _ostanCsvData = [];
		var _shahrestanCsvData = [];
		var _ostanTopoData = [];
		var _shahrestanTopoData = [];
		
		// 1: location resolution is Ostan; otherwise is Shahrestan
		var isOstan = 0;
		
		// selected (current) Ostan ID
		var curLocID = "2301"
		
		// current year
		var curYear = 1390;
				
		var svg; // global variable for map svg

		var tooltip2 = d3.select("body").append("div")
			.attr("class", "hidden tooltip");
		var tooltip = d3.select("body").append("div")
			.attr("class", "hidden tooltip");
		
		configParameters();
		
		// load external files (csv + topo)
		queue()
			.defer(d3.csv, ostanCsvUrl)
			.defer(d3.csv, shahrestanCsvUrl)
			.defer(d3.json, ostanTopoUrl)
			.defer(d3.json, shahrestanTopoUrl)
			.await(DataReady);
			
		function DataReady(error, ostanCsvData, shahrestanCsvData, ostanTopoData, shahrestanTopoData) {	
			if (error) throw error;

			// setting global variables
			shahrestanCsvData.forEach(function(d) {
				s = d[locIdFieldInCsv] + "";
				d[locIdFieldInCsv] = ("0").repeat(4-s.length) + s;
			});
			_ostanCsvData = ostanCsvData;
			_shahrestanCsvData = shahrestanCsvData;
			_ostanTopoData = ostanTopoData;
			_shahrestanTopoData = shahrestanTopoData;
		
			subsetChanged(true);
			//filterData();
			//drawMap(topoData);
			//updateMap();
		}
		
		// This function is called once, in order to read all csv & topo files.
		function loadData()
		{
		}
		
		function filterData()
		{
			var tempData = [];
			
			if (isOstan == 1)
				{
					topoData = _ostanTopoData;
					tempData = _ostanCsvData;
					locNameFieldInCsv = 'Pername';//'Code';
				}
			else
				{
					topoData = _shahrestanTopoData;
					tempData = _shahrestanCsvData;
					locNameFieldInCsv = 'city';
				}
				
			//var sexParams = getSelectValues(sexSubset);
			//var ageParams = getSelectValues(ageSubset);
			//var resParams = getSelectValues(resSubset);
			var sexParams = getSelectValues_("#sexCheckList");
			var ageParams = getSelectValues_("#ageCheckList");
			var resParams = getSelectValues_("#settlementCheckList");
			
			csvData = tempData.filter(function(d) { 
				return sexParams.includes(d.sex) 
					&& ageParams.includes(d.age) 
					&& resParams.includes(d.settlement); });
		}
		
		function configParameters()
		{
			
			/*var csvData;
			if (isOstan == 1)
				csvData = _ostanCsvData;
			else
				csvData = _shahrestanCsvData;
			
			var categories = [ {name: 'settlement', values:[], name:'sex', values: [], name: 'age', values[]};
			var catLength = categories.length;
			for (var i=0; i < catLength; i++)
			{
				categories[i].values = 
					d3.map(csvData, function(d) { return d[categories[i].name]; }).keys();
				d3.select("header").append("")
			}*/
			
		}
		
		
		// This function is used to draw the map.
		//
		// Input: topoData     - the topoJson object used for drawing
		//
		function drawMap(topoData)
		{
			var width = 1000, height = 600;
			var projection = d3.geo.mercator()
				.center([51, 32])
				.scale(2000)
				.translate([350, height / 2 + 25])
				.precision(0);
			
			/*d3.selectAll("body svg.hidden")
				.remove();*/
						
			var path = d3.geo.path()
				.projection(projection);
			
			var pathSimplified = function(d) 
			{
				return path(d).replace(/(\.\d{1})\d+/g, '$1');
			}
			
			var map = d3.map();
			
			var quantize = d3.scale.quantize()
				.domain([100, 4000])
				.range(d3.range(11).map(function (i) { return "q" + i + "-11"}));		
										
			d3.selectAll("#main svg")
				.attr('class', 'hidden');
				
			ssvg = d3.select("#main #locType" + isOstan);
					
			// do not redraw if already drawn. just hide/show.
			if (!ssvg.empty())
			{
				ssvg.attr("class", "nothidden");
				return;
			}
					
			 svg = d3.select("#main").append('svg')
				.attr('width', width)
				.attr('height', height)
				.attr('id', 'loctype' + isOstan)
				.attr('class', 'nothidden');
				
				//
				var topo = topojson.feature(topoData, topoData.objects["iran-amarcoded"]);
								
				svg.append("g")
					.attr("class", "provinces")
					.selectAll('path')
						.data(topo.features)
					.enter().append('path')
					.attr('d', pathSimplified)
					.attr('class', 'province')
					.attr('locid', function(d) { return d.id; })
					.attr('toponame', function(d) { return d.properties.name; })
					.attr("pername", function(d) {
						return d.properties.name; })/*
						provData = csvData.find(function(x) { return x[locIdFieldInCsv] == d.id});
						if (provData && provData[locNameFieldInCsv])
							return provData[locNameFieldInCsv];
						else
							return "N/A";
					})*/
					.on("mousemove", function (d) {
						var mouse = d3.mouse(svg.node()).map(function (d) {
							return parseInt(d);
						});
						var selectedValue = getRadioVal("valueSelector");
						var valueTag = selectedValue.startsWith("percent") ? "درصد" : "نفر";
						var factor = selectedValue.startsWith("percent") ? 100 : 1;

						tooltip
							.classed('hidden', false)
							.style('left', mouse[0]+20)
							.style('top', mouse[1]+50)
							.html(this.getAttribute('toponame') + " (" + this.getAttribute('locid') +")" + "<br>" + numberWithCommas(Math.trunc(this.getAttribute('pop') * factor)) + " " + valueTag);
						})
					.on("mouseout", function() {
						tooltip.classed('hidden', true);
					})
					.on("click", function(d) { 
						//drawOstan(d); 
						//drawBarCharts(d.id);
						selectLocation(d.id);
					});
					;
				var provOosData = d3.nest()
					.key(function (d) { return d.province; })
					.rollup(function(d) {
						return d3.sum(d, function(h) { return h["population.total"] }); 
					}).entries(_oosData);
					
				provOosData.forEach(function (d) {
					d.city = d.key;
					d.pop = d.values;
				});			
				
				yearChange(curYear);
		}
		
		function activateCurOstan(locID) {
			oldOstans = d3.select(".nothidden path.selected");
			if (!oldOstans.empty())
			{
				oldOstans
					.attr('class', 'province')
					.style('stroke', null)
					.style('stroke-width', null);
			}
			curOstan = d3.select(".nothidden [locid='"+locID+"']");
			curOstanStyle = curOstan.attr('style');
			curOstan
				.attr('class', 'selected')
				/*.attr('style', curOstanStyle.replace('fill', 'fill') + ';background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAIUlEQVQIW2NkYGD4D8SMQAwD/2EcmASYRlEB04FTJYaZAMxBCQQo0O1/AAAAAElFTkSuQmCC) repeat;')
				*/
				//.attr('style', curOstanStyle + ';stroke: green; stroke-width: 3px');
				//.style('stroke', 'green')
				//.style('stroke-width', '3px');
		}
		
		function drawOstan(d)
		{
			//console.log(d);
			var data = _provData.find( function(x) { return x.code == d.id});

			d3.select("#ostan")
				.select("h").remove();
			d3.select("#ostan")
				.append("h")
				.text(data.toponame);
			topoUrl = 'topo/C' + data.filename + '-.json';
			//console.log(topoUrl);
			
			queue()
				.defer(d3.json, topoUrl)
				.await( function (error, topoj) 
					{				
						var width = 400;
						var height = 400;
						ostanSvg = d3.select("#ostansvg")
							.attr('width', width)
							.attr('height', height);
						var topo = topojson.feature(topoj, topoj.objects['C'+data.filename]);
						
						  var center = d3.geo.centroid(topo)
						  var scale  = 150;
						  var offset = [width/2, height/2];
						  var projection = d3.geo.mercator().scale(scale).center(center)
							  .translate(offset);

						  // create the path
						  var path = d3.geo.path().projection(projection);

						  // using the path determine the bounds of the current map and use 
						  // these to determine better values for the scale and translation
						  var bounds  = path.bounds(topo);
						  var hscale  = scale*width  / (bounds[1][0] - bounds[0][0]);
						  var vscale  = scale*height / (bounds[1][1] - bounds[0][1]);
						  var scale   = (hscale < vscale) ? hscale : vscale;
						  //scale = scale * 0.9;
						  var offset  = [width - (bounds[0][0] + bounds[1][0])/2,
											height - (bounds[0][1] + bounds[1][1])/2];

						  // new projection
						  projection = d3.geo.mercator().center(center)
							.scale(scale).translate(offset);
						  path = path.projection(projection);
						
						ostanSvg.selectAll("g")
							.remove();
						ostanSvg.append("g")
							.attr("class", "subunit")
							.selectAll('path')
								.data(topo.features)
							.enter().append('path')
							.attr('d', path)
							.attr('class', 'subunit')
							.attr('id', function(d) { return d.id })
							.on("mousemove", function (d) {
								var mouse = d3.mouse(svg.node()).map(function (d) {
									return parseInt(d);
								});
								tooltip.classed('hidden', false)
									.attr('style', 'left:' + (mouse[0]+15) + 'px; top:' + (mouse[1]-35) + 'px')
									.html(this.getAttribute('id') + "<br>" + this.getAttribute('pop'));
								})
							.on("mouseout", function() {
								tooltip.classed('hidden', true);
							})
							.on("click", function(d) { drawOstan(d); });
						//drawlegend(quantize);
						//yearChange(1385);
					});
		}
		
		function drawLineChart(d)
		{
			var margin = { top: 10, right: 50, bottom: 10, left: 50 };
			var width = 400 - margin.right - margin.left, 
				height = 400 - margin.top - margin.bottom;
			data = _csvData.find( function(x) { return x.Code == d.id});
			lineData = [];
			for (k in data)
			{
				if (data.hasOwnProperty(k) && !isNaN(k)) {
					lineData.push({x: +k, y: +data[k]});
				}
			}
			var x = d3.scale.linear()
				.range([0, width]);

			var y = d3.scale.linear()
				.range([height, 0]);

			var xAxis = d3.svg.axis()
				.scale(x)
				.orient("bottom");

			var yAxis = d3.svg.axis()
				.scale(y)
				.orient("left");

			var line = d3.svg.line()
				.x(function(d) { return x(+d.x) })
				.y(function(d) { return y(+d.y) });

			
			x.domain(d3.extent(lineData, function(d) { return d.x; } )); //[1385, 1395]);
			y.domain(d3.extent(lineData, function(d) { return d.y; } )); //[100, 4000]);

			svg = d3.select("#LineChart")
				.attr('width', width + margin.left + margin.right)
				.attr('height', height + margin.top + margin.bottom);
		
			svg.selectAll("svg")
				.remove();
						
			svg = svg.append('svg')
				.attr('width', width + margin.left + margin.right)
				.attr('height', height + margin.top + margin.bottom)
				.append('g')
					.attr('transform', 'translate(' + margin.left + ', ' + margin.top + ')');
			
			svg.append("g")
				.attr("class", "x axis")
				.attr("transform", "translate(0," + height + ")")
				.call(xAxis);

			svg.append("g")
				.attr("class", "y axis")
				.call(yAxis)
			.append("text")
				.attr("transform", "rotate(-90)")
				.attr("y", 6)
				.attr("dy", ".71em")
				.style("text-anchor", "end")
				.text("Population");

			svg.selectAll(".line")
				.remove();
			
			svg.append("path")
				.datum(lineData)
				.attr("class", "line")
				.attr("d", line);
		}		
		
		function drawBarChartField(locID, fieldname, elementID)
		{		
			/* <div ELEMENTID>
					<svg>
						<g>
							<g x axis>
							<g y axis>
							<rect>
							<rect>
							<rect>
							...
						</g>
					</svg>
				</div>*/
							
		
			var el = d3.select("#"+ elementID);
			if (el.empty())
				return;
			var margin = {top: 10, right: 50, bottom: 30, left: 50},
				width = 300 - margin.left - margin.right,
				height = 200 - margin.top - margin.bottom;

			if (fieldname == 'age')
				width = 600 - margin.left - margin.right;
				
			var x = d3.scale.ordinal()
				.rangeRoundBands([0, width], .5);

			var y = d3.scale.linear()
				.range([height, 0]);

			var xAxis = d3.svg.axis()
				.scale(x)
				.orient("bottom");


			// title of the bar
			curLocation = d3.select(".nothidden [locid='"+locID+"']");
			if (curLocation)
				curLocation = curLocation.attr("pername")
			else
				curLocation = "N/A";

			locPrefix = isOstan == 1 ? "استان " : "شهرستان ";
			el = d3.select("div.titledChart#"+elementID);
			var barTitle = el.selectAll('.barTitle').data([1]);
			barTitle.enter().append("div");
			barTitle.transition()
				.attr('class', 'barTitle')
				.text(locPrefix + curLocation);
				
			var selectedValue = getRadioVal("valueSelector");
			var aggregateField = selectedValue.replace("percent.", "");

			ticksymbol = selectedValue.startsWith("percent") ? "%" : "";
			var yAxis = d3.svg.axis()			
				.scale(y)
				.orient("left")
				.ticks(10, ticksymbol);

			var svg = d3.select("#" + elementID)
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom);
				
			/*svg.selectAll("svg")
				.remove();
			*/
			svg = svg.selectAll('svg').data([1]);
			//svg.exit().remove();
			svg.enter().append("svg")
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom);
			
			svg = svg.selectAll('g').data([1]);
			//svg.exit().remove();
			svg.enter()
				.append("g")
					.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
			  			  
 			var oosData = d3.nest()
				.key(function (d) { return d[fieldname]; })
				.rollup(function(d) {
					if (selectedValue.startsWith("percent"))
					// case 1: calculate percent
						return Math.trunc(100 * d3.sum(d, function(h) { return h[aggregateField]; }) 
							/ d3.sum(d, function (g) { return g["population.total"]; }) ) / 100;
					else
					// case 2:
						return d3.sum(d, function(h) { return h[aggregateField]; });
				}).entries(    // filter by current locID
					csvData.filter(function (p) { return p[locIdFieldInCsv] == locID; } )
					);				
			oosData.forEach(function (d) {
				d.field = d.key;
				d.pop = isNaN(d.values) ? 0 : d.values;
			});
			  
			x.domain(oosData.map(function(d) { return d.field; }));
			//y.domain([0, d3.max(oosData, function(d) { return d.pop; })]);
			
			// now calculate maximum value in chart, in order to set axis-range
 			var aggData = d3.nest()
				.key(function (d) { return d[locIdFieldInCsv]; })
				.key(function (d) { return d[fieldname];})
				.rollup(function(d) {
					if (selectedValue.startsWith("percent"))
					// case 1: calculate percent
						return Math.trunc(100 * d3.sum(d, function(h) { return h[aggregateField]; }) 
							/ d3.sum(d, function (g) { return g["population.total"]; }) ) / 100;
					else
					// case 2:
						return d3.sum(d, function(h) { return h[aggregateField]; });
				}).entries(
					csvData.filter(function(p) { return p[locIdFieldInCsv] == locID; })
				);								
						
			//y.domain([0, 1.1 * d3.max(aggData, function(d) { return d.values; })]);
			maxvalue = 1.1 * d3.max(aggData, function(d) { return d3.max(d.values, function(e) { return e.values; })});
			y.domain([0, maxvalue]);
						
			var axis = svg.selectAll('g.x.axis').data([1]);
						
			//axis.exit().remove();

			axis.enter().append("g")
				.attr("class", "x axis")
				.attr("transform", "translate(0," + height + ")")
				.call(xAxis)
			.append("text")
				.attr("x", width)
				.attr("dy", ".71em")
				.style("text-anchor", "start")
				.text(fieldname);
				
			axis.transition()
				.duration(750)
				.call(xAxis);
				  
			axis = svg.selectAll('g.y.axis').data([1]);
			
			t0 = svg.transition().duration(750);
			var oldMaxvalue;
			if (!axis.empty())
				oldMaxvalue = axis.attr("maxvalue");
			if (oldMaxvalue)
			{
				var oldy = d3.scale.linear()
					.range([height, 0])
					.domain([0, oldMaxvalue]);
				
				var bar = svg.selectAll(".bar")
					.data(oosData);
				bar
					.attr("pop", function(d) { return d.pop;} )
					.attr(fieldname, function(d) { return d.field; });
					
					// always update (w/ transition)
				bar = t0.selectAll('.bar');
				bar
					.attr("y", function(d) { return oldy(d.pop); })
					.attr("height", function (d) {return height - oldy(d.pop); })
					.attr("x", function(d) { return x(d.field); })
					.attr("width", x.rangeBand());
			}

			//axis.exit().remove();
			axis.enter().append("g")
				.attr("class", "y axis")
				.call(yAxis)
			.append("text")
				  .attr("transform", "rotate(-90)")
				  .attr("y", 6)
				  .attr("dy", ".71em")
				  .style("text-anchor", "end")
				  .text("data");

			axis
				.attr("maxvalue", maxvalue)

			
			t1 = t0.transition();
			axis = t1.selectAll('g.y.axis');
			axis
				.call(yAxis);
				  
			var bar = svg.selectAll(".bar")
				.data(oosData);
				
			bar.exit().remove();
				
			bar.enter().append("rect")
				.attr("class", "bar")
				.attr("y", height) //function(d) { return y(d.pop); })
				.attr("height", 0)//function(d) { return height - y(d.pop); })
				.attr("rx", 3)
				.attr("ry", 3)
				.on("mousemove", function (d) {
					/*var mouse = d3.mouse(this).map(function (d) {
						return parseInt(d);
					});*/
					var selectedValue = getRadioVal("valueSelector");
					var valueTag = "", value = "";
					if (selectedValue.startsWith("percent"))
					{
						valueTag = "درصد"; 
						value = Math.trunc(this.getAttribute('pop') * 100);
					}
					else {
						valueTag = "نفر";
						value = numberWithCommas(this.getAttribute('pop'));
					}
					tooltip2
						.classed('hidden', false)
						.style('left', d3.event.pageX+15)
						.style('top', d3.event.pageY-35)
						.html(this.getAttribute(fieldname) + "<br>" + value + " " + valueTag);
					})
				.on("mouseout", function() {
					tooltip2.classed('hidden', true)
				});
				
				// always update (w/o transition)
			bar
				.attr("pop", function(d) { return d.pop;} )
				.attr(fieldname, function(d) { return d.field; });
				
				// always update (w/ transition)
			bar = t1.selectAll('.bar');
			bar/*.transition()
				.duration(750)*/
				.attr("y", function(d) { return y(d.pop); })
				.attr("height", function (d) {return height - y(d.pop); })
				.attr("x", function(d) { return x(d.field); })
				.attr("width", x.rangeBand());
				
			
				
			function type(d) {
			  d.pop = +d.pop;
			  return d;
			}

		}
		
		function drawBarChartLocComparison(locID)
		{			
			var filteredData = [];
			var locType = 0;
			var motherId = "";
			var curMotherName = ""
			if (locID.length > 2) // shahrestan - show all shahrestans in the same ostan 
			{
				motherId = locID.substr(0, 2);
				filteredData = csvData.filter(function (p) { return p[locIdFieldInCsv].substr(0, 2) == motherId; });
				locType = 1;
				curMotherName = "استان " + d3.select('[locid="'+locID.substr(0, 2)+'"]').attr('toponame');
			}
			else  // ostan - show all ostans' aggregated data
			{
				motherId = 'iran';
				filteredData = csvData;
				locType = 0;
				curMotherName = "کل کشور";
			}			

			/*provData = _csvData.find(function(x) { return x.Code == d.id});
				colr = 255;
				colg = Math.round(255 - provData[value] / 3000 * 255);
				colb = Math.round(255 - provData[value] / 3000 * 255);
				stylecol = "fill: rgb(" + colr + ',' + colg + ',' + colb + ')'; 
				*/
				//stylecol = "fill: rgb(0, 0, 255)";
			var margin = {top: 10, right: 50, bottom: 50, left: 50},
				width = 600 - margin.left - margin.right,
				height = 230 - margin.top - margin.bottom;

			var x = d3.scale.ordinal()
				.rangeRoundBands([0, width], .3);

			var y = d3.scale.linear()
				.rangeRound([height, 0]);

			var yAxis = d3.svg.axis()
				.scale(y)
				.orient("left");

			var xAxis = d3.svg.axis()
				.scale(x)
				.ticks(0)//.ticks(10, "%");
				.orient("bottom")
			
			var barTitle = d3.select("#locCompare").selectAll('.barTitle').data([1]);
			barTitle.enter().append("div");
			
			barTitle			
				.attr('class', 'barTitle')
				.text(curMotherName);
			
			var svg = d3.select("#ostansvg");

			
			if (svg.attr('locid') != motherId)
			{
				// change in data. remove old elements.
					svg.selectAll("rect")
						.remove();
			}
			svg
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom)
				.attr('locid', motherId)
				
			
			svg = svg.selectAll('g').data([1]); // only 1 element is needed. first time append, next times update.
			
			svg.enter().append("g")
				.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
			  			  
			var selectedValue = getRadioVal("valueSelector");
			var aggregateField = selectedValue.replace("percent.", "");
						
			var oosData = d3.nest()
				.key(function (d) { return locType == 1 ? d[locIdFieldInCsv].substr(2, 2): d[locIdFieldInCsv]; })
				.rollup(function(d) {
					if (selectedValue.startsWith("percent"))
					// case 1: calculate percent
						return Math.trunc(100 * d3.sum(d, function(h) { return h[aggregateField]; }) 
							/ d3.sum(d, function (g) { return g["population.total"]; }));
						
					else
					// case 2:
						return d3.sum(d, function(h) { return h[aggregateField]; });
				}).entries(
					filteredData //csvData.filter(function (p) { return p.Code == d.id; } )
					);
				
			oosData.forEach(function (d) {
				d.loc = d.key;
				if (locType == 0) // ostan
				{					
					d.name = filteredData.find(function(u) { return u[locIdFieldInCsv] == d.key })[
					locNameFieldInCsv];
					d.selected = d.loc == locID;
				}
				else // shahrestan
				{
					d.name = filteredData.find(function(u) { return u[locIdFieldInCsv].substr(2, 2) == d.key})[locNameFieldInCsv];
					d.selected = (motherId + d.loc) == locID;
				}
				d.pop = d.values;
			});
			
			oosData.sort(function (a, b) { return b.pop - a.pop; });
			  
			x.domain(oosData.map(function(d) { return d.name; /*d3.select('[locid="' + d.loc + '"]').attr('toponame'); */}));
			y.domain([0, 1.2*d3.max(oosData, function(d) { return d.pop; })]);

			var axis = svg.selectAll("g.x.axis").data([1]);
			//axis.exit().remove();	
			axis.enter().append("g")
				.attr("class", "x axis")
				.attr("transform", "translate(0, " + (height + 20) + ")")
				.call(xAxis)
				.selectAll("text")
					.style("text-anchor", "middle")
					//.attr("transform", "rotate(-90)"
					.attr("dy", ".35em");
				
			axis
				.call(xAxis)
				.selectAll("text")
					.attr("transform", function(d) { return "rotate(-90,"+ this.getAttribute("x") + "," + this.getAttribute("y") + ") translate(25, 0)"; })
					.style("text-anchor", "end");
			axis
				.selectAll("line")
				.remove();
			
			/*axis.transition()
				.duration(750)
				.call(xAxis)
				.selectAll("text")
					.attr("transform", function(d) { return "rotate(-90,"+ this.getAttribute("x") + "," + this.getAttribute("y") + ")"; })
					.style("text-anchor", "end")
				.selectAll('line')
				.remove();
			*/
			
			axis = svg.selectAll("g.y.axis").data([1]);
			//axis.exit().remove();
			axis.enter().append("g")
				.attr("class", "y axis")
				//.attr("transform", "translate(0, " + -height + ")")
				//.call(yAxis)
				.selectAll("text")
				  //.attr("transform", "rotate(-90)")
				  .attr("y", 6)
				  .attr("dy", ".71em")
				  .style("text-anchor", "end")
				  .text("Population");
			  
			axis
				.call(yAxis);
				 
			var bars = svg.selectAll(".bar")
				.data(oosData, function(d) { return d.loc; });

			//bars.exit().remove();

			// create bars in the first place
			bars.enter().append("rect")
				.classed('bar', true)
				.attr("y", height)//function(d) {return y(d.name); })
				.attr("height", 0)//y.rangeBand())
				.attr("x", function(d) { return x(d.name); })
				.attr("width", x.rangeBand()) //0) //function(d) { return x(d.pop); })
				.attr("loc", function(d) { return d.loc; })
				.attr("locname", function(d) { return d.name;})
				.on('click', function(d) {
					var l = this.getAttribute('loc');
					if (locType == 1)
						l = motherId + l;
					selectLocation(l);
				})
				.on("mousemove", function (d) {
					var selectedValue = getRadioVal("valueSelector");
					var valueTag = selectedValue.startsWith("percent") ? "درصد" : "نفر";
					tooltip2
						.classed('hidden', false)
						.style('left', d3.event.pageX+15)
						.style('top', d3.event.pageY-35)
						.html(this.getAttribute('locname') + "<br>" + numberWithCommas(this.getAttribute('pop')) + " " + valueTag);
				})
				.on("mouseout", function() {
					tooltip2.classed('hidden', true)
				});
					
				// change without transition
				bars
					.classed('selected', function(d) { 
						return d.selected; })
					.attr('style', function(d) {
						return locType == 0 ?
							d3.select("[locid='"+ d.loc +"']").attr("style") 
							:  d3.select("[locid='"+ motherId + d.loc +"']").attr("style");
					})
					.attr("pop", function(d) { return d.pop;} )
				
				// change with transition
				bars.transition()
					.duration(750)
					.attr("y", function(d) { return y(d.pop); })
					.attr("height", function(d) { return height - y(d.pop); })
					.attr("x", function(d) { return x(d.name); });
				
			/*function type(d) {
			  d.pop = +d.pop;
			  return d;
			}*/

		}
		
		function yearChange(value)
		{
			var lowColor = "Beige" ;//  "#faf0e6"; // linen
			var highColor = "#BB0000"; // "#800000"
			var colorInterpolator = d3.interpolateRgb(lowColor, highColor);				

			var selectedValue = getRadioVal("valueSelector");
			var aggregateField = selectedValue.replace("percent.", "");
			
			// group data by location ID
		
			var oosData = d3.nest()
				.key(function (d) { return d[locIdFieldInCsv]; })
				.rollup(function(d) {
					if (selectedValue.startsWith("percent"))
					// case 1:
						return d3.sum(d, function(h) { 
							return h[aggregateField]; }) / d3.sum(d, function (g) { return g["population.total"]; })
					else
					// case 2:
						return d3.sum(d, function(h) {
							return h[aggregateField]; });
				}).entries(
					csvData.filter(function (p) { return p[timeFieldInCsv] == value; } )
					);
				
			oosData.forEach(function (d) {
				d.id = d.key;
				d.pop = d.values;
			});
			
			var x = d3.scale.linear()
				.range([0, 1])
				//.domain([0, d3.max(oosData, function(d) { return d.pop; })]);
				.domain([d3.min(oosData, function(d) { return d.pop; }), d3.max(oosData, function(d) { return d.pop; })]);
				
			//$yearSlider.text = value;
			d3.selectAll("path")
				//.data(_csvData, function(d) { console.log(d.Code); return d.Code})
				/*.attr("class", function(d) { 
					provData = _csvData.find(function(x) { return x.Code == d.id})
					return quantize(provData[value]); 
				})*/
		
			.attr("style", function(d) {
					provData = oosData.find(function(x) { return x.id == d.id});
					if (provData)
					{
					col = colorInterpolator(x(provData.pop));
					//colr = 255;
					//colg = x(provData.pop); 
					//colb = x(provData.pop); 
					return "fill: " + col; //rgb(" + colr + ',' + colg + ',' + colb + ')'; 
					}
					else
						return "";
				})
				.attr("pop", function(d) {
					provData = oosData.find(function(x) { return x.id == d.id});
					if (provData && provData["pop"])
						return Math.round(provData.pop * 100) / 100;
					else
						return "N/A";
				});
				
			return;
			// draw legend
				var color_domain = [50, 150, 350, 750, 1500]
				var ext_color_domain = [100, 100+354, 100 + 2*354, 100 + 3*354, 100 + 4*354, 
					100+5*354, 100 + 6*354, 100 + 7*354, 100 + 8*354, 100+9*354, 100 + 10*354]
				
				var legend_labels = ["<= 100", "450+", "800+", "1150+", "1500+", "1850+", "2200+", "2550+", "2900+", "3250+", "> 3250"] 
				
				var height = 800;
				var numTicks = 10;
				var domain = x.ticks(numTicks);
				
				col = d3.scale.ordinal()
					.domain(domain)
					.range([0, domain.length*20]);
				
				var legend = svg.selectAll("g.legend")
					.data(domain)
					.enter().append("g")
					.attr('class', 'legend');
				
				var ls_w = 20, ls_h = 20;
				
				legend.append("rect")
					.attr("x", 20)
					.attr("y", function(d, i) { return height - 250 - (i*ls_h) - ls_h; })
					.attr("width", ls_w)
					.attr("height", ls_h)
					.style('fill', function(d) {
						return 'rgb(255, ' + x(d) + ',' + x(d) + ')'; });
					
				legend.append("text")
					.attr("x", 50)
					.attr("y", function(d, i) { return height - 250 - (i*ls_h) - 2 * ls_h;})
					.text(function(d, i) { return ((i == 0) || (i == Math.round(domain.length / 2)) || (i == domain.length)) ? domain[i] : ""; });

		}		
		
		function drawBarCharts(locID)
		{
			activateCurOstan(locID);
			drawBarChartField(locID, "sex", "barChart1");
			drawBarChartField(locID, "settlement", "barChart2");
			drawBarChartField(locID, "age", "barChart3");						
			drawBarChartLocComparison(locID);
		}
		
		function selectLocation(newLocID)
		{
			//selectOnMap(newLocID);
			if (curLocID != newLocID)
			{
				activateCurOstan(newLocID);
				drawBarCharts(newLocID);
				curLocID = newLocID;
			}
		}
		
		function numberWithCommas(x) {
			return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
		}
	</script>
</html>
